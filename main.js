!function(){"use strict";class t{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(t){if(!(t instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=t}drawUi(t){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(t=>this.onNewGameClick(t))),this.saveGameEl.addEventListener("click",(t=>this.onSaveGameClick(t))),this.loadGameEl.addEventListener("click",(t=>this.onLoadGameClick(t))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(t);for(let t=0;t<this.boardSize**2;t+=1){const i=document.createElement("div");i.classList.add("cell","map-tile","map-tile-"+((e=t)===(s=this.boardSize)*(s-1)?"bottom-left":e===s-s?"top-left":e===s-1?"top-right":e<s?"top":e===s*s-1?"bottom-right":e>s*(s-1)?"bottom":e%s==0?"left":e%s==s-1?"right":"center")),i.addEventListener("mouseenter",(t=>this.onCellEnter(t))),i.addEventListener("mouseleave",(t=>this.onCellLeave(t))),i.addEventListener("click",(t=>this.onCellClick(t))),this.boardEl.appendChild(i)}var e,s;this.cells=Array.from(this.boardEl.children)}redrawPositions(t){for(const t of this.cells)t.innerHTML="";for(const s of t){const t=this.boardEl.children[s.position],i=document.createElement("div");i.classList.add("character",s.character.type);const a=document.createElement("div");a.classList.add("health-level");const l=document.createElement("div");l.classList.add("health-level-indicator","health-level-indicator-"+((e=s.character.health)<15?"critical":e<50?"normal":"high")),l.style.width=`${s.character.health}%`,a.appendChild(l),i.appendChild(a),t.appendChild(i)}var e}addCellEnterListener(t){this.cellEnterListeners.push(t)}addCellLeaveListener(t){this.cellLeaveListeners.push(t)}addCellClickListener(t){this.cellClickListeners.push(t)}addNewGameListener(t){this.newGameListeners.push(t)}addSaveGameListener(t){this.saveGameListeners.push(t)}addLoadGameListener(t){this.loadGameListeners.push(t)}onCellEnter(t){t.preventDefault();const e=this.cells.indexOf(t.currentTarget);this.cellEnterListeners.forEach((t=>t.call(null,e)))}onCellLeave(t){t.preventDefault();const e=this.cells.indexOf(t.currentTarget);this.cellLeaveListeners.forEach((t=>t.call(null,e)))}onCellClick(t){const e=this.cells.indexOf(t.currentTarget);this.cellClickListeners.forEach((t=>t.call(null,e)))}onNewGameClick(t){t.preventDefault(),this.newGameListeners.forEach((t=>t.call(null)))}onSaveGameClick(t){t.preventDefault(),this.saveGameListeners.forEach((t=>t.call(null)))}onLoadGameClick(t){t.preventDefault(),this.loadGameListeners.forEach((t=>t.call(null)))}static showError(t){alert(t)}static showMessage(t){alert(t)}selectCell(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(t),this.cells[t].classList.add("selected",`selected-${e}`)}deselectCell(t){const e=this.cells[t];e.classList.remove(...Array.from(e.classList).filter((t=>t.startsWith("selected"))))}deselectCellAll(){this.cells.forEach((t=>{t.classList.remove(...Array.from(t.classList).filter((t=>t.startsWith("selected"))))}))}showCellTooltip(t,e){this.cells[e].title=t}hideCellTooltip(t){this.cells[t].title=""}showDamage(t,e){return new Promise((s=>{const i=this.cells[t],a=document.createElement("span");a.textContent=e,a.classList.add("damage"),i.appendChild(a),a.addEventListener("animationend",(()=>{i.removeChild(a),s()}))}))}setCursor(t){this.boardEl.style.cursor=t}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}var e="prairie",s="desert",i="arctic",a="mountain";class l{constructor(t,e,s){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:100,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"generic";if(this.type=a,this.health=i,this.level=t,this.attack=e,this.defence=s,"Character"===new.target.name)throw new Error("Its basic class must use new operator with a Person")}}class h{constructor(t){this.characters=t}}function*r(t,e){for(;;){const s=Math.floor(Math.random()*t.length),i=Math.ceil(Math.random()*e),a=t[s];yield new a(i)}}function o(t,e,s){const i=[];for(let a=1;a<=s;a+=1){const s=r(t,e).next().value;i.push(s)}return new h(i)}const n=[class extends l{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"bowman";super(t,e),this.type=s,this.attack=25,this.defence=25,this.radiusAttack=2,this.radiusStep=2;for(let t=1;t<this.level;t+=1)this.attack=Math.max(this.attack,this.attack*((80+e)/100)),this.defence=Math.max(this.defence,this.defence*((80+e)/100))}},class extends l{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"swordsman";super(t,e,s),this.type=s,this.attack=40,this.defence=10,this.radiusAttack=1,this.radiusStep=4;for(let t=1;t<this.level;t+=1)this.attack=Math.max(this.attack,this.attack*((80+e)/100)),this.defence=Math.max(this.defence,this.defence*((80+e)/100))}},class extends l{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"magician";super(t,e,s),this.type=s,this.attack=10,this.defence=40,this.radiusAttack=4,this.radiusStep=1;for(let t=1;t<this.level;t+=1)this.attack=Math.max(this.attack,this.attack*((80+e)/100)),this.defence=Math.max(this.defence,this.defence*((80+e)/100))}}],c=[class extends l{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"vampire";super(t,e,s),this.type=s,this.attack=25,this.level=t,this.defence=25,this.radiusAttack=2,this.radiusStep=2;for(let t=1;t<this.level;t+=1)this.attack=Math.max(this.attack,this.attack*((80+e)/100)),this.defence=Math.max(this.defence,this.defence*((80+e)/100))}},class extends l{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"undead";super(t,e,s),this.type=s,this.attack=40,this.level=t,this.defence=10,this.radiusAttack=1,this.radiusStep=4;for(let t=1;t<this.level;t+=1)this.attack=Math.max(this.attack,this.attack*((80+e)/100)),this.defence=Math.max(this.defence,this.defence*((80+e)/100))}},class extends l{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"daemon";super(t,e),this.type=s,this.attack=10,this.level=t,this.defence=10,this.radiusAttack=4,this.radiusStep=1;for(let t=1;t<this.level;t+=1)this.attack=Math.max(this.attack,this.attack*((80+e)/100)),this.defence=Math.max(this.defence,this.defence*((80+e)/100))}}];class d{constructor(t,e){if(!(t instanceof l))throw new Error("character must be instance of Character or its children");if("number"!=typeof e)throw new Error("position must be a number");this.character=t,this.position=e}}class m{static from(t,e,s,i){let a={};return a={player:t,positions:e,theme:s,level:i},a}}const f=new t;f.bindToDOM(document.querySelector("#game-container"));const p=new class{constructor(t){this.storage=t}save(t){this.storage.setItem("state",JSON.stringify(t))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(t){throw new Error("Invalid state")}}}(localStorage),v=new class{constructor(t,e){this.fieldSize=8,this.positionedChar=[],this.theme="prairie",this.gamePlay=t,this.stateService=e,this.newGame=this.newGame.bind(this),this.saveGame=this.saveGame.bind(this),this.loadGame=this.loadGame.bind(this),this.onCellEnter=this.onCellEnter.bind(this),this.onCellLeave=this.onCellLeave.bind(this),this.onCellClick=this.onCellClick.bind(this),this.stepOfComputer=this.stepOfComputer.bind(this),this.selectedCell=null,this.allowedTeam=["swordsman","bowman","magician"],this.personIntoActiveCell=[],this.selectedCharacter=[],this.stateOfMovement={move:null,attack:null,restricted:null},this.level=1,this.score=0,this.positionsToDraw=[],this.positionsPlayer=this.createTeam(o(n,this.level,3),this.fieldSize,0),this.positionsRival=this.createTeam(o(c,this.level,3),this.fieldSize,this.fieldSize-2),this.positionsToDraw=this.positionsPlayer.concat(this.positionsRival),this.state=m.from(!0,this.positionsToDraw,this.theme,this.level)}createTeam(t,e,s){const i=Math.floor(Math.random()*e)*e+s+Math.floor(2*Math.random());if(this.positionedChar.find((t=>t.position===i))||this.positionsToDraw.find((t=>t.position===i)))return this.createTeam(t,e,s);if(this.positionedChar.splice(this.positionedChar.length,1,new d(t.characters[this.positionedChar.length],i)),this.positionedChar.length!==t.characters.length)return this.createTeam(t,e,s);const a=this.positionedChar;return this.positionedChar=[],a}init(){return this.makeSubscribe(),this.gamePlay.drawUi(e),this.gamePlay.redrawPositions(this.positionsToDraw),m.from(!0,this.positionsToDraw,this.theme,this.level)}onCellClick(e){let s=[];if(this.state.player?this.allowedTeam=["swordsman","bowman","magician"]:this.allowedTeam=["daemon","vampire","undead"],null!==this.selectedCell){if(this.stateOfMovement.move&&!this.personIntoActiveCell.length>=1)return this.positionsToDraw.forEach((t=>{t.position===this.selectedCell&&(t.position=this.activeCell)})),this.gamePlay.deselectCellAll(),this.selectedCell=null,this.state.player?(this.state.player=!this.state.player,this.state=m.from(this.state.player,this.positionsToDraw,this.theme,this.level),this.gamePlay.redrawPositions(this.positionsToDraw),setTimeout((()=>this.stepOfComputer()),1e3)):(this.state.player=!0,this.gamePlay.redrawPositions(this.positionsToDraw));if(this.stateOfMovement.attack){let t=0;return t=Math.ceil(Math.max(this.selectedCharacter[0].character.attack-this.personIntoActiveCell[0].character.defence,.1*this.selectedCharacter[0].character.attack)),this.gamePlay.deselectCellAll(),this.selectedCell=null,this.state.player?this.state.player=!this.state.player:this.state.player=!0,this.gamePlay.showDamage(this.activeCell,t).then((()=>(this.positionsToDraw.forEach((s=>{s.position===e&&(s.character.health-=t)})),this.positionsToDraw=this.positionsToDraw.filter((t=>t.character.health>0)),0===this.positionsToDraw.filter((t=>"swordsman"===t.character.type&&t.character.health>0||("bowman"===t.character.type&&t.character.health)>0||("magician"===t.character.type&&t.character.health)>0)).length?this.gameOver():(this.gamePlay.redrawPositions(this.positionsToDraw),this.state=m.from(this.state.player,this.positionsToDraw,this.theme,this.level),this.state)))),this.state.player?this.gamePlay.deselectCellAll():setTimeout((()=>this.stepOfComputer()),1e3)}if(this.stateOfMovement.restricted)return t.showError("Недопустимое действие")}return this.personIntoActiveCell.length>=1?(s=this.allowedTeam.filter((t=>this.personIntoActiveCell[0].character.type===t)),s.length>=1?(this.charactersOnField=this.gamePlay.cells.filter((t=>t.firstElementChild)),this.gamePlay.deselectCellAll(),this.selectedCell=e,this.selectedCharacter=this.positionsToDraw.filter((t=>t.position===this.selectedCell)),this.gamePlay.selectCell(e)):t.showError("Выберите доступного персонажа")):s}onCellEnter(t){let e;if(this.activeCell=t,this.personIntoActiveCell=this.positionsToDraw.filter((t=>t.position===this.activeCell)),null!==this.selectedCell&&(e=this.makeAttackStep(this.selectedCell,this.activeCell)),this.personIntoActiveCell.length>=1&&(this.gamePlay.showCellTooltip(this.infoAbout(this.personIntoActiveCell[0].character),t),this.allowedTeam.includes(this.personIntoActiveCell[0].character.type)))return this.gamePlay.setCursor("pointer"),this.stateOfMovement={move:null,attack:null,restricted:null},this.stateOfMovement;if(this.gamePlay.setCursor("default"),null!==this.selectedCell){if(e.step&&this.selectedCharacter.length>=1&&!this.personIntoActiveCell.length>=1)return this.gamePlay.setCursor("pointer"),this.gamePlay.selectCell(this.activeCell,"green"),this.stateOfMovement.move=!0,this.stateOfMovement.attack=!1,this.stateOfMovement.restricted=!1,this.stateOfMovement;if(e.attack&&this.selectedCell!==t&&this.personIntoActiveCell.length>=1&&!this.allowedTeam.includes(this.personIntoActiveCell[0].character.type))return this.gamePlay.setCursor("crosshair"),this.gamePlay.selectCell(this.activeCell,"red"),this.stateOfMovement.attack=!0,this.stateOfMovement.move=!1,this.stateOfMovement.restricted=!1,this.stateOfMovement;if(!1===e.attack&&!1===e.step&&this.personIntoActiveCell.length<1||null!==this.selectedCell&&!1===e.attack||null!==this.selectedCell&&!1===e.step)return this.gamePlay.setCursor("not-allowed"),this.stateOfMovement.attack=!1,this.stateOfMovement.move=!1,this.stateOfMovement.restricted=!0,this.stateOfMovement}return this.stateOfMovement}onCellLeave(t){this.selectedCell!==t&&(this.gamePlay.deselectCell(t),this.gamePlay.hideCellTooltip(t))}infoAbout(t){return this.currentPerson=t,`🎖${t.level} ⚔ ${t.attack} 🛡${t.defence} ❤${t.health}`}makeSubscribe(){this.gamePlay.addCellEnterListener(this.onCellEnter),this.gamePlay.addCellLeaveListener(this.onCellLeave),this.gamePlay.addCellClickListener(this.onCellClick),this.gamePlay.addNewGameListener(this.newGame),this.gamePlay.addSaveGameListener(this.saveGame),this.gamePlay.addLoadGameListener(this.loadGame)}makeAttackStep(t,e,s){if(null===t||!this.selectedCharacter.length>=1)return{step:!1,attack:!1};const i=Math.abs(t-e),a=s||this.gamePlay.cells[t].firstElementChild.classList[1],{radiusAttack:l}=this.selectedCharacter[0].character,{radiusStep:h}=this.selectedCharacter[0].character;let r=null,o=null;const n=Math.floor(Math.abs(t/this.fieldSize)),c=Math.floor(Math.abs(e/this.fieldSize));return"swordsman"!==a&&"undead"!==a||(r=i<=l&&n===c||Math.abs(i-this.fieldSize)<=l&&n!==c,o=i<=h&&n===c||Math.abs(i-this.fieldSize)<=h&&c===n+1||Math.abs(i-this.fieldSize)<=h&&c===n-1||Math.abs(i-2*this.fieldSize)<=h&&c===n+2||Math.abs(i-2*this.fieldSize)<=h&&c===n-2||Math.abs(i-3*this.fieldSize)<=h&&c===n+3||Math.abs(i-3*this.fieldSize)<=h&&c===n-3||Math.abs(i-4*this.fieldSize)<=h&&c===n+4||Math.abs(i-4*this.fieldSize)<=h&&c===n-4),"bowman"!==a&&"vampire"!==a||(r=i<=l&&n===c||Math.abs(i-this.fieldSize)<=l&&c===n+1||Math.abs(i-this.fieldSize)<=l&&c===n-1||Math.abs(i-2*this.fieldSize)<=l&&c===n+2||Math.abs(i-2*this.fieldSize)<=l&&c===n-2,o=r),"magician"!==a&&"daemon"!==a||(r=i<=l&&n===c||Math.abs(i-this.fieldSize)<=l&&c===n+1||Math.abs(i-this.fieldSize)<=l&&c===n-1||Math.abs(i-2*this.fieldSize)<=l&&c===n+2||Math.abs(i-2*this.fieldSize)<=l&&c===n-2||Math.abs(i-3*this.fieldSize)<=l&&c===n+3||Math.abs(i-3*this.fieldSize)<=l&&c===n-3||Math.abs(i-4*this.fieldSize)<=l&&c===n+4||Math.abs(i-4*this.fieldSize)<=l&&c===n-4,o=i<=h&&n===c||Math.abs(i-this.fieldSize)<=h&&c===n+1||Math.abs(i-this.fieldSize)<=h&&c===n-1),{step:o,attack:r}}stepOfComputer(){const t=this.positionsToDraw.filter((t=>("vampire"===t.character.type&&t.character.health)>0||("daemon"===t.character.type&&t.character.health)>0||("undead"===t.character.type&&t.character.health)>0));if(4===this.level&&0===t.length)return this.gameOver();if(0===t.length)return this.nextLevel();const e=t.findIndex((t=>t.character.health<=100&&t.character.health>0)),s=this.positionsToDraw.filter((t=>"swordsman"===t.character.type&&t.character.health>0||("bowman"===t.character.type&&t.character.health)>0||("magician"===t.character.type&&t.character.health)>0));t[e].row=Math.floor(Math.abs(t[e].position/this.fieldSize)),t[e].column=t[e].position%this.fieldSize,s.forEach((s=>{s.diff=s.position-t[e].position,s.row=Math.floor(Math.abs(s.position/this.fieldSize)),s.column=Math.abs(s.position%this.fieldSize),s.diffRow=Math.abs(t[e].row-s.row),s.diffColumn=Math.abs(t[e].column-s.column),s.diagonal=Math.abs(t[e].row-s.row)+Math.abs(t[e].column-s.column)}));const i=s.reduce(((t,e)=>t.diagonal<e.diagonal?t:e));if(i.positionTarget=i.position,this.onCellEnter(t[e].position),this.onCellClick(t[e].position),this.onCellEnter(i.position),this.stateOfMovement.attack)return this.onCellEnter(i.position),this.onCellClick(i.position);if(i.row<=t[e].row&&i.column<t[e].column&&t[e].row<=1)for(;!this.stateOfMovement.move;)this.onCellEnter(i.positionTarget+=1);if(i.row===t[e].row&&i.column>t[e].column)for(;!this.stateOfMovement.move;)this.onCellEnter(i.positionTarget+=1);if(i.row===t[e].row&&i.column<t[e].column)for(;!this.stateOfMovement.move;)this.onCellEnter(i.positionTarget-=1);if(i.row>t[e].row&&i.column<=t[e].column)for(;!this.stateOfMovement.move;)this.onCellEnter(i.positionTarget-=1);if(i.row<t[e].row&&i.column<=t[e].column)for(;!this.stateOfMovement.move;)this.onCellEnter(i.positionTarget+=1);if(i.row>t[e].row&&i.column>=t[e].column)for(;!this.stateOfMovement.move;)this.onCellEnter(i.positionTarget-=1);if(i.row<t[e].row&&i.column>=t[e].column)for(;!this.stateOfMovement.move;)this.onCellEnter(i.positionTarget+=1);return this.onCellClick(this.activeCell)}nextLevel(){switch(this.level+=1,this.level){case 2:this.gamePlay.drawUi(s),this.theme=s;break;case 3:this.gamePlay.drawUi(i),this.theme=i;break;case 4:this.gamePlay.drawUi(a),this.theme=a;break;default:this.gamePlay.drawUi(e),this.theme=e}const t=this.createTeam(o(n,this.level,3),this.fieldSize,0);if(this.positionsPlayer=this.positionsToDraw.slice(0,3),this.positionsPlayer.forEach(((e,s)=>{e.character.level=this.level,e.character.attack=Math.ceil(Math.max(e.character.attack,e.character.attack*((80+e.character.health)/100))),e.character.defence=Math.ceil(Math.max(e.character.defence,e.character.defence*((80+e.character.health)/100))),e.character.health<=20?e.character.health+=80:e.character.health=100,e.position=t[s].position})),this.positionsPlayer.length<3)for(let e=1;e<t.length;e=this.positionsPlayer.length)this.positionsPlayer.push(t[t.length-e]);return this.positionsRival=this.createTeam(o(c,this.level,3),this.fieldSize,this.fieldSize-2),this.positionsToDraw=this.positionsPlayer.concat(this.positionsRival),this.state=m.from(!0,this.positionsToDraw,this.theme,this.level),this.gamePlay.redrawPositions(this.positionsToDraw)}gameOver(){return this.gamePlay.redrawPositions([]),t.showError("Игра окончена")}newGame(){return this.selectedCell=null,this.level=1,this.positionsPlayer=this.createTeam(o(n,this.level,3),this.fieldSize,0),this.positionsRival=this.createTeam(o(c,this.level,3),this.fieldSize,this.fieldSize-2),this.positionsToDraw=this.positionsPlayer.concat(this.positionsRival),this.gamePlay.drawUi(e),this.gamePlay.redrawPositions(this.positionsToDraw),this.state=m.from(!0,this.positionsToDraw,this.theme,this.level),this.state}saveGame(){return this.positionsToDraw.length?(this.stateService.save(this.state),t.showMessage("Игра успешно сохранена!")):t.showError("ВНИМАНИЕ! Нет игры для сохранения!")}loadGame(){return this.stateService.load()?(this.selectedCell=null,this.state=this.stateService.load(),this.state.player=!0,this.level=this.state.level,this.positionsToDraw=this.state.positions,this.theme=this.state.theme,this.gamePlay.drawUi(this.theme),this.gamePlay.redrawPositions(this.positionsToDraw),t.showMessage("Игра успешно загружена!")):(this.state.player=!0,t.showError("ВНИМАНИЕ! Нет игры для загрузки!"))}}(f,p);v.init()}();